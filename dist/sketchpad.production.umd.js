!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.Sketchpad=i()}(this,function(){"use strict";var e=function(){function i(){this.last=i.FLAG_PENCEL,this.backup=i.FLAG_PENCEL,this.current=0,this.startPoint={x:0,y:0},this.endPoint={x:0,y:0},this.points=[]}return i.prototype.startWorking=function(){0===this.current&&(this.current=this.backup)},i.prototype.endWorking=function(){this.backup=this.current,this.current=0},i.prototype.isWorking=function(){return 0<this.current},i.prototype.setTool=function(t){t!==i.FLAG_ERASER&&(this.last=t),this.backup=t,this.current=0},i.prototype.restoreTool=function(){this.backup=this.last,this.current=0},i.prototype.setStartPoint=function(t){var i=t.x,s=t.y;this.startPoint.x=i,this.startPoint.y=s},i.prototype.getStartPoint=function(){var t=this.startPoint;return{x:t.x,y:t.y}},i.prototype.setEndPoint=function(t){var i=t.x,s=t.y;this.endPoint.x=i,this.endPoint.y=s},i.prototype.getEndPoint=function(){var t=this.endPoint;return{x:t.x,y:t.y}},i.prototype.appendPoints=function(t){this.points.push(t)},i.prototype.clearPoints=function(){this.points=[]},i.FLAG_PENCEL=1,i.FLAG_ERASER=2,i.FLAG_S_LINE=3,i.FLAG_RECTANGLE=4,i.FLAG_CIRCLE=5,i.FLAG_S_RECTANGLE=6,i.FLAG_ROUND=7,i}();function n(t,i){var s=i.clientX||i.touches[0].clientX,e=i.clientY||i.touches[0].clientY;return{x:s-t.offsetLeft,y:e-t.offsetTop}}function o(t,i){t.beginPath();for(var s=0,e=i;s<e.length;s++){var n=e[s];n===i[0]?t.moveTo(n.x,n.y):t.lineTo(n.x,n.y)}t.stroke()}function a(t,i){t.beginPath();var s=i[0],e=i[1];t.moveTo(s.x,s.y),t.lineTo(e.x,e.y),t.stroke()}function r(t,i,s){void 0===s&&(s=!1),t.beginPath();var e=i[0],n=i[1];if(t.rect(e.x,e.y,n.x-e.x,n.y-e.y),s){var o=t.lineWidth;t.lineWidth=0,t.fill(),t.lineWidth=o}else t.stroke()}function c(t,i,s){void 0===s&&(s=!1),t.beginPath();var e=i[0],n=i[1],o=n.x-e.x,a=n.y-e.y;if(t.arc(e.x+o/2,e.y+a/2,Math.hypot(o,a)/2,0,2*Math.PI,!0),s){var r=t.lineWidth;t.lineWidth=0,t.fill(),t.lineWidth=r}else t.stroke()}function h(t,i){r(t,i,!0)}function u(t,i){c(t,i,!0)}function l(t,i,s){t.beginPath(),t.arc(i,s,8,0,2*Math.PI,!0),t.fill()}function i(i,t){return t.map(function(t){return{x:t.x*i.width/1e4,y:t.y*i.height/1e4}})}function s(i,t){return t.map(function(t){return{x:Math.round(t.x/i.width*1e4),y:Math.round(t.y/i.height*1e4)}})}function d(t){t.getContext("2d").clearRect(0,0,t.width,t.height)}var p=function(){function t(t){this.status=new e,this.canvas=t.canvas,this.ctx=this.canvas.getContext("2d"),this.onDrawEnd=null;var i=2;"number"==typeof t.lineWidth&&(i=t.lineWidth),"function"==typeof t.onDrawEnd&&(this.onDrawEnd=t.onDrawEnd),this.canvas.width=t.width,this.canvas.height=t.height,this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundPosition="center",this.canvas.style.backgroundSize="cover",this.ctx.globalCompositeOperation="source-over",this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.lineWidth=i,this.vcanvas=document.createElement("canvas"),this.vcanvas.style.position="fixed",this.resize(),this.vctx=this.vcanvas.getContext("2d"),this.vctx.globalCompositeOperation="source-over",this.vctx.lineCap="round",this.vctx.lineJoin="round",this.vctx.lineWidth=i,this.canvas.parentElement.appendChild(this.vcanvas),this.vcanvas.ontouchstart=this.touchStartHandler.bind(this),this.vcanvas.ontouchmove=this.touchMoveHandler.bind(this),this.vcanvas.ontouchend=this.touchEndHandler.bind(this),this.vcanvas.onmousedown=this.touchStartHandler.bind(this),this.vcanvas.onmousemove=this.touchMoveHandler.bind(this),this.vcanvas.onmouseup=this.touchEndHandler.bind(this),this.resize=this.resize.bind(this),window.addEventListener("resize",this.resize)}return t.prototype.resize=function(){var t=this.canvas.getBoundingClientRect();this.vcanvas.width=t.width,this.vcanvas.height=t.height,this.vcanvas.style.top=t.top+"px",this.vcanvas.style.left=t.left+"px"},t.prototype.destroy=function(){this.canvas.parentElement.removeChild(this.vcanvas),this.vcanvas=null,window.removeEventListener("resize",this.resize)},t.prototype.send=function(t,i){"function"==typeof this.onDrawEnd&&this.onDrawEnd(t,i)},t.prototype.touchStartHandler=function(t){this.status.startWorking();var i=n(this.canvas,t);switch(this.status.setStartPoint(i),this.status.current){case e.FLAG_PENCEL:case e.FLAG_ERASER:this.status.clearPoints(),this.status.appendPoints(i)}},t.prototype.touchMoveHandler=function(t){if(this.status&&this.status.isWorking()){var i=n(this.canvas,t);this.status.setEndPoint(i),this.status.appendPoints(i);var s=[this.status.getStartPoint(),i];switch(this.status.current){case e.FLAG_PENCEL:o(this.vctx,this.status.points);break;case e.FLAG_S_LINE:this.clearVCanvas(),a(this.vctx,s);break;case e.FLAG_RECTANGLE:this.clearVCanvas(),r(this.vctx,s);break;case e.FLAG_CIRCLE:this.clearVCanvas(),c(this.vctx,s);break;case e.FLAG_S_RECTANGLE:this.clearVCanvas(),h(this.vctx,s);break;case e.FLAG_ROUND:this.clearVCanvas(),u(this.vctx,s);break;case e.FLAG_ERASER:l(this.ctx,i.x,i.y)}}},t.prototype.touchEndHandler=function(){var t=[this.status.getStartPoint(),this.status.getEndPoint()];switch(this.status.current){case e.FLAG_PENCEL:this.clearVCanvas(),0<this.status.points.length&&(this.drawLineDirectly(this.status.points),this.send("line",s(this.canvas,this.status.points)));break;case e.FLAG_S_LINE:this.clearVCanvas(),this.drawSLineDirectly(t),this.send("s-line",s(this.canvas,t));break;case e.FLAG_RECTANGLE:this.clearVCanvas(),this.drawRectangleDirectly(t),this.send("rectangle",s(this.canvas,t));break;case e.FLAG_CIRCLE:this.clearVCanvas(),this.drawCircleDirectly(t),this.send("circle",s(this.canvas,t));break;case e.FLAG_S_RECTANGLE:this.clearVCanvas(),this.drawSRectangleDirectly(t),this.send("s-rectangle",s(this.canvas,t));break;case e.FLAG_ROUND:this.clearVCanvas(),this.drawRoundDirectly(t),this.send("round",s(this.canvas,t));break;case e.FLAG_ERASER:0<this.status.points.length&&this.send("eraser",s(this.canvas,this.status.points))}this.status.endWorking()},t.prototype.toBeRounded=function(){this.ctx.lineCap="round",this.ctx.lineJoin="round",this.vctx.lineCap="round",this.vctx.lineJoin="round"},t.prototype.toBeRected=function(){this.ctx.lineCap="butt",this.ctx.lineJoin="miter",this.vctx.lineCap="butt",this.vctx.lineJoin="miter"},t.prototype.setDrawWay=function(t){this.ctx.globalCompositeOperation=t,this.vctx.globalCompositeOperation=t},t.prototype.usePencil=function(){this.toBeRounded(),this.setDrawWay("source-over"),this.status.setTool(e.FLAG_PENCEL)},t.prototype.useSLine=function(){this.toBeRounded(),this.setDrawWay("source-over"),this.status.setTool(e.FLAG_S_LINE)},t.prototype.useRectangle=function(){this.toBeRected(),this.setDrawWay("source-over"),this.status.setTool(e.FLAG_RECTANGLE)},t.prototype.useCircle=function(){this.toBeRounded(),this.setDrawWay("source-over"),this.status.setTool(e.FLAG_CIRCLE)},t.prototype.useSRectangle=function(){this.toBeRected(),this.setDrawWay("source-over"),this.status.setTool(e.FLAG_S_RECTANGLE)},t.prototype.useRound=function(){this.toBeRounded(),this.setDrawWay("source-over"),this.status.setTool(e.FLAG_ROUND)},t.prototype.useEraser=function(){this.setDrawWay("destination-out"),this.status.setTool(e.FLAG_ERASER)},t.prototype.changeColor=function(t){this.setDrawWay("source-over"),this.ctx.strokeStyle=t,this.ctx.fillStyle=t,this.vctx.strokeStyle=t,this.vctx.fillStyle=t,this.status.restoreTool(),this.status.current!==e.FLAG_RECTANGLE&&this.status.current!==e.FLAG_S_RECTANGLE||this.toBeRected()},t.prototype.changeLineWidth=function(t){this.ctx.lineWidth=t,this.vctx.lineWidth=t},t.prototype.changeBackground=function(t){this.canvas.style.backgroundImage=t?"url("+t+")":"none"},t.prototype.drawLineDirectly=function(t){o(this.ctx,t)},t.prototype.drawSLineDirectly=function(t){a(this.ctx,t)},t.prototype.drawRectangleDirectly=function(t){r(this.ctx,t)},t.prototype.drawSRectangleDirectly=function(t){h(this.ctx,t)},t.prototype.drawCircleDirectly=function(t){c(this.ctx,t)},t.prototype.drawRoundDirectly=function(t){u(this.ctx,t)},t.prototype.drawEraserDirectly=function(t){!function(t,i){for(var s=0,e=i;s<e.length;s++){var n=e[s];l(t,n.x,n.y)}}(this.ctx,t)},t.prototype.drawLine=function(t){t=i(this.canvas,t),this.drawLineDirectly(t)},t.prototype.drawSLine=function(t){t=i(this.canvas,t),this.drawSLineDirectly(t)},t.prototype.drawRectangle=function(t){t=i(this.canvas,t),this.drawRectangleDirectly(t)},t.prototype.drawSRectangle=function(t){t=i(this.canvas,t),this.drawSRectangleDirectly(t)},t.prototype.drawCircle=function(t){t=i(this.canvas,t),this.drawCircleDirectly(t)},t.prototype.drawRound=function(t){t=i(this.canvas,t),this.drawRoundDirectly(t)},t.prototype.drawEraser=function(t){t=i(this.canvas,t),this.drawEraserDirectly(t)},t.prototype.clearCanvas=function(){d(this.canvas)},t.prototype.clearVCanvas=function(){d(this.vcanvas)},t}();return function(t){return new p(t)}});
